# Подготовка виртуальной машины

## Склонируйте репозиторий

Склонируйте репозиторий проекта:

```
git clone https://github.com/yandex-praktikum/mle-project-sprint-4-v001.git
```

## Активируйте виртуальное окружение

Используйте то же самое виртуальное окружение, что и созданное для работы с уроками. Если его не существует, то его следует создать.

Создать новое виртуальное окружение можно командой:

```
python3 -m venv env_recsys_start
```

После его инициализации следующей командой

```
. env_recsys_start/bin/activate
```

установите в него необходимые Python-пакеты следующей командой

```
pip install -r requirements.txt
```

### Скачайте файлы с данными

Для начала работы понадобится три файла с данными:
- [tracks.parquet](https://storage.yandexcloud.net/mle-data/ym/tracks.parquet)
- [catalog_names.parquet](https://storage.yandexcloud.net/mle-data/ym/catalog_names.parquet)
- [interactions.parquet](https://storage.yandexcloud.net/mle-data/ym/interactions.parquet)
 
Скачайте их в директорию локального репозитория. Для удобства вы можете воспользоваться командой wget:

```
wget https://storage.yandexcloud.net/mle-data/ym/tracks.parquet

wget https://storage.yandexcloud.net/mle-data/ym/catalog_names.parquet

wget https://storage.yandexcloud.net/mle-data/ym/interactions.parquet
```

## Запустите Jupyter Lab

Запустите Jupyter Lab в командной строке

```
jupyter lab --ip=0.0.0.0 --no-browser
```

# Расчёт рекомендаций

Код для выполнения первой части проекта находится в файле `recommendations.ipynb`. Изначально, это шаблон. Используйте его для выполнения первой части проекта.

# Сервис рекомендаций

Код сервиса рекомендаций находится в файле `recommendations_service.py`.

Необходимые шаги для запуска сервиса рекомендаций

1. Прежде чем запускать сервис, в корне проекта нужно создать папку recommendations и положить туда файлы из персонального s3 бакета:
recommendations.parquet
top_popular.parquet
similar_items.parquet
Все файлы находятся в папке recsys/recommendations, имя бакета: s3-student-mle-20240729-c37e1cdb33

2. Запускаем необходимые сервисы командами:
сервис рекомендаций: "uvicorn recommendation_servive:app"
сервис выдачи похожих айтемов: "uvicorn features_service:app --port 8010"
сервис онлайн событий: "uvicorn events_service:app --port 8020"

Стратегия тестирования:
1. Возьмем пользователя из определенного сценария (в test_service.py приведены все три сценария), и сгенерируем для него несколько взаимодействий (если сценарий того требует) с некоторыми айтемами (при помощи ендпойнта events_store_url + "/put").
2. Посмотрим на получившиейся взаимодействия (ендпойнт events_store_url + "/get").
3. Проверим онлайн рекомендации по трем последним айтемам пользователя, сгенерируем 5 рекомендаций для каждого айтема из similar_items.parquet при помощи ендпойнта recommendations_url + "/recommendations_online". Получаем максимум 15 рекомендций (если нет дублей). При сценарии отсутствия онлайн-рекомендаций получаем пустой список.
4. Сгенерируем смешанные рекомендации при помощи ендпойнта recommendations_url + "/recommendations", стратегия блендирования следующая: рекомендации с нечетными индексами из оффлайн рекомендаций, четными - из онлайн. У конечных сблендированных рекомендаций оставляем первые пять. Также рядом выводим как офлайн и онлайн, так и смешанные рекомендации, чтобы удостовериться, что все правильно. В случае отсутсвия у user_id персональных рекомендаций, берутся top_popular. В случае отсутствия онлайн рекомендаций, берем все онлайн, без блендирования.

# Инструкции для тестирования сервиса

Код для тестирования сервиса находится в файле `test_service.py`.

Запускаем сервис тестирования "python3 test_service.py". После этого вывод появится в файле test_service.log. Логи появляются только после локального запуска, их нет в github, так как добавлены в .gitignore.
